<?xml version="1.0" encoding="UTF-8"?>
<zabbix_export>
    <version>5.0</version>
    <date>2022-01-17T19:19:19Z</date>
    <groups>
        <group>
            <name>rdbms/postgres</name>
        </group>
        <group>
            <name>Templates</name>
        </group>
    </groups>
    <templates>
        <template>
            <template>postgres pgbackrest backup server</template>
            <name>postgres pgbackrest backup server</name>
            <description>monitoring van pgbackrest backups</description>
            <groups>
                <group>
                    <name>rdbms/postgres</name>
                </group>
                <group>
                    <name>Templates</name>
                </group>
            </groups>
            <applications>
                <application>
                    <name>backup</name>
                </application>
            </applications>
            <items>
                <item>
                    <name>pgbackrest.json</name>
                    <type>TRAP</type>
                    <key>pgbackrest.json</key>
                    <delay>0</delay>
                    <history>0</history>
                    <trends>0</trends>
                    <value_type>TEXT</value_type>
                    <description>get latest backup info from pgbackrest info --output=json</description>
                    <applications>
                        <application>
                            <name>backup</name>
                        </application>
                    </applications>
                </item>
                <item>
                    <name>pgbackrest[count]</name>
                    <type>DEPENDENT</type>
                    <key>pgbackrest[count]</key>
                    <delay>0</delay>
                    <history>8d</history>
                    <description># of databases backedup by pgbackrest on this host</description>
                    <applications>
                        <application>
                            <name>backup</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$.length()</params>
                        </step>
                        <step>
                            <type>DISCARD_UNCHANGED_HEARTBEAT</type>
                            <params>1d</params>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>pgbackrest.json</key>
                    </master_item>
                </item>
            </items>
            <discovery_rules>
                <discovery_rule>
                    <name>pgbackrest.lld</name>
                    <type>DEPENDENT</type>
                    <key>pgbackrest.lld</key>
                    <delay>0</delay>
                    <item_prototypes>
                        <item_prototype>
                            <name>pgbackrest[{#NAME},full,age]</name>
                            <type>DEPENDENT</type>
                            <key>pgbackrest[{#NAME},full,age]</key>
                            <delay>0</delay>
                            <history>8d</history>
                            <units>s</units>
                            <description>age of last (#TYPE} backup in seconds</description>
                            <applications>
                                <application>
                                    <name>backup</name>
                                </application>
                            </applications>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$.[?(@.name==&quot;{#NAME}&quot; &amp;&amp; @.type==&quot;full&quot;)].timestamp.age.first()</params>
                                    <error_handler>DISCARD_VALUE</error_handler>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>pgbackrest.json</key>
                            </master_item>
                            <trigger_prototypes>
                                <trigger_prototype>
                                    <expression>{last()}&gt;8d</expression>
                                    <name>last full backup of {#NAME} older than 1 week</name>
                                    <priority>WARNING</priority>
                                    <description>expecting a weekly full backup</description>
                                    <tags>
                                        <tag>
                                            <tag>backup</tag>
                                            <value>{#NAME}-{#TYPE}</value>
                                        </tag>
                                    </tags>
                                </trigger_prototype>
                            </trigger_prototypes>
                        </item_prototype>
                        <item_prototype>
                            <name>pgbackrest[{#NAME},full,db,delta]</name>
                            <type>DEPENDENT</type>
                            <key>pgbackrest[{#NAME},full,db,delta]</key>
                            <delay>0</delay>
                            <history>8d</history>
                            <units>B</units>
                            <applications>
                                <application>
                                    <name>backup</name>
                                </application>
                            </applications>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$.[?(@.name==&quot;{#NAME}&quot; &amp;&amp; @.type==&quot;full&quot;)].info.delta.first()</params>
                                    <error_handler>DISCARD_VALUE</error_handler>
                                </step>
                                <step>
                                    <type>DISCARD_UNCHANGED_HEARTBEAT</type>
                                    <params>1d</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>pgbackrest.json</key>
                            </master_item>
                        </item_prototype>
                        <item_prototype>
                            <name>pgbackrest[{#NAME},full,db,size]</name>
                            <type>DEPENDENT</type>
                            <key>pgbackrest[{#NAME},full,db,size]</key>
                            <delay>0</delay>
                            <history>8d</history>
                            <units>B</units>
                            <description>dbsize as it runs</description>
                            <applications>
                                <application>
                                    <name>backup</name>
                                </application>
                            </applications>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$.[?(@.name==&quot;{#NAME}&quot; &amp;&amp; @.type==&quot;full&quot;)].info.size.first()</params>
                                    <error_handler>DISCARD_VALUE</error_handler>
                                </step>
                                <step>
                                    <type>DISCARD_UNCHANGED_HEARTBEAT</type>
                                    <params>1d</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>pgbackrest.json</key>
                            </master_item>
                        </item_prototype>
                        <item_prototype>
                            <name>pgbackrest[{#NAME},full,repo,delta]</name>
                            <type>DEPENDENT</type>
                            <key>pgbackrest[{#NAME},full,repo,delta]</key>
                            <delay>0</delay>
                            <history>8d</history>
                            <units>B</units>
                            <applications>
                                <application>
                                    <name>backup</name>
                                </application>
                            </applications>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$.[?(@.name==&quot;{#NAME}&quot; &amp;&amp; @.type==&quot;full&quot;)].info.repository.delta.first()</params>
                                    <error_handler>DISCARD_VALUE</error_handler>
                                </step>
                                <step>
                                    <type>DISCARD_UNCHANGED_HEARTBEAT</type>
                                    <params>1d</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>pgbackrest.json</key>
                            </master_item>
                        </item_prototype>
                        <item_prototype>
                            <name>pgbackrest[{#NAME},full,repo,size]</name>
                            <type>DEPENDENT</type>
                            <key>pgbackrest[{#NAME},full,repo,size]</key>
                            <delay>0</delay>
                            <history>8d</history>
                            <units>B</units>
                            <description>size of db in the repository</description>
                            <applications>
                                <application>
                                    <name>backup</name>
                                </application>
                            </applications>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$.[?(@.name==&quot;{#NAME}&quot; &amp;&amp; @.type==&quot;full&quot;)].info.repository.size.first()</params>
                                    <error_handler>DISCARD_VALUE</error_handler>
                                </step>
                                <step>
                                    <type>DISCARD_UNCHANGED_HEARTBEAT</type>
                                    <params>1d</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>pgbackrest.json</key>
                            </master_item>
                        </item_prototype>
                        <item_prototype>
                            <name>pgbackrest[{#NAME},full,speed]</name>
                            <type>CALCULATED</type>
                            <key>pgbackrest[{#NAME},full,speed]</key>
                            <delay>10m</delay>
                            <history>8d</history>
                            <value_type>FLOAT</value_type>
                            <units>Bps</units>
                            <params>last(&quot;pgbackrest[{#NAME},full,repo,delta]&quot;,0) /&#13;
 (last(&quot;pgbackrest[{#NAME},full,stop]&quot;,0)-last(&quot;pgbackrest[{#NAME},full,start]&quot;,0))</params>
                            <applications>
                                <application>
                                    <name>backup</name>
                                </application>
                            </applications>
                            <preprocessing>
                                <step>
                                    <type>DISCARD_UNCHANGED_HEARTBEAT</type>
                                    <params>1d</params>
                                </step>
                            </preprocessing>
                        </item_prototype>
                        <item_prototype>
                            <name>pgbackrest[{#NAME},full,start]</name>
                            <type>DEPENDENT</type>
                            <key>pgbackrest[{#NAME},full,start]</key>
                            <delay>0</delay>
                            <history>8d</history>
                            <units>unixtime</units>
                            <applications>
                                <application>
                                    <name>backup</name>
                                </application>
                            </applications>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$.[?(@.name==&quot;{#NAME}&quot; &amp;&amp; @.type==&quot;full&quot;)].timestamp.start.first()</params>
                                    <error_handler>DISCARD_VALUE</error_handler>
                                </step>
                                <step>
                                    <type>DISCARD_UNCHANGED_HEARTBEAT</type>
                                    <params>1d</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>pgbackrest.json</key>
                            </master_item>
                        </item_prototype>
                        <item_prototype>
                            <name>pgbackrest[{#NAME},full,stop]</name>
                            <type>DEPENDENT</type>
                            <key>pgbackrest[{#NAME},full,stop]</key>
                            <delay>0</delay>
                            <history>8d</history>
                            <units>unixtime</units>
                            <applications>
                                <application>
                                    <name>backup</name>
                                </application>
                            </applications>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$.[?(@.name==&quot;{#NAME}&quot; &amp;&amp; @.type==&quot;full&quot;)].timestamp.stop.first()</params>
                                    <error_handler>DISCARD_VALUE</error_handler>
                                </step>
                                <step>
                                    <type>DISCARD_UNCHANGED_HEARTBEAT</type>
                                    <params>1d</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>pgbackrest.json</key>
                            </master_item>
                        </item_prototype>
                        <item_prototype>
                            <name>pgbackrest[{#NAME},incr,age]</name>
                            <type>DEPENDENT</type>
                            <key>pgbackrest[{#NAME},incr,age]</key>
                            <delay>0</delay>
                            <history>8d</history>
                            <units>s</units>
                            <applications>
                                <application>
                                    <name>backup</name>
                                </application>
                            </applications>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$.[?(@.name==&quot;{#NAME}&quot; &amp;&amp; @.type==&quot;incr&quot;)].timestamp.age.first()</params>
                                    <error_handler>DISCARD_VALUE</error_handler>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>pgbackrest.json</key>
                            </master_item>
                            <trigger_prototypes>
                                <trigger_prototype>
                                    <expression>{last()}&gt;2d</expression>
                                    <name>last {#TYPE} backup older than 2 days</name>
                                    <priority>WARNING</priority>
                                    <description>expecting daily incr, except for full day backup</description>
                                    <dependencies>
                                        <dependency>
                                            <name>no backup activity seen for {#NAME} in last 26h</name>
                                            <expression>{postgres pgbackrest backup server:pgbackrest[{#NAME},type].nodata(26h)}=1</expression>
                                        </dependency>
                                    </dependencies>
                                    <tags>
                                        <tag>
                                            <tag>backup</tag>
                                            <value>{#NAME}-{#TYPE}</value>
                                        </tag>
                                    </tags>
                                </trigger_prototype>
                            </trigger_prototypes>
                        </item_prototype>
                        <item_prototype>
                            <name>pgbackrest[{#NAME},incr,db,delta]</name>
                            <type>DEPENDENT</type>
                            <key>pgbackrest[{#NAME},incr,db,delta]</key>
                            <delay>0</delay>
                            <history>8d</history>
                            <units>B</units>
                            <applications>
                                <application>
                                    <name>backup</name>
                                </application>
                            </applications>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$.[?(@.name==&quot;{#NAME}&quot; &amp;&amp; @.type==&quot;incr&quot;)].info.delta.first()</params>
                                    <error_handler>DISCARD_VALUE</error_handler>
                                </step>
                                <step>
                                    <type>DISCARD_UNCHANGED_HEARTBEAT</type>
                                    <params>1d</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>pgbackrest.json</key>
                            </master_item>
                        </item_prototype>
                        <item_prototype>
                            <name>pgbackrest[{#NAME},incr,db,size]</name>
                            <type>DEPENDENT</type>
                            <key>pgbackrest[{#NAME},incr,db,size]</key>
                            <delay>0</delay>
                            <history>8d</history>
                            <units>B</units>
                            <applications>
                                <application>
                                    <name>backup</name>
                                </application>
                            </applications>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$.[?(@.name==&quot;{#NAME}&quot; &amp;&amp; @.type==&quot;incr&quot;)].info.size.first()</params>
                                    <error_handler>DISCARD_VALUE</error_handler>
                                </step>
                                <step>
                                    <type>DISCARD_UNCHANGED_HEARTBEAT</type>
                                    <params>1d</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>pgbackrest.json</key>
                            </master_item>
                        </item_prototype>
                        <item_prototype>
                            <name>pgbackrest[{#NAME},incr,repo,delta]</name>
                            <type>DEPENDENT</type>
                            <key>pgbackrest[{#NAME},incr,repo,delta]</key>
                            <delay>0</delay>
                            <history>8d</history>
                            <units>B</units>
                            <applications>
                                <application>
                                    <name>backup</name>
                                </application>
                            </applications>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$.[?(@.name==&quot;{#NAME}&quot; &amp;&amp; @.type==&quot;incr&quot;)].info.repository.delta.first()</params>
                                    <error_handler>DISCARD_VALUE</error_handler>
                                </step>
                                <step>
                                    <type>DISCARD_UNCHANGED_HEARTBEAT</type>
                                    <params>1d</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>pgbackrest.json</key>
                            </master_item>
                        </item_prototype>
                        <item_prototype>
                            <name>pgbackrest[{#NAME},incr,repo,size]</name>
                            <type>DEPENDENT</type>
                            <key>pgbackrest[{#NAME},incr,repo,size]</key>
                            <delay>0</delay>
                            <history>8d</history>
                            <units>B</units>
                            <applications>
                                <application>
                                    <name>backup</name>
                                </application>
                            </applications>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$.[?(@.name==&quot;{#NAME}&quot; &amp;&amp; @.type==&quot;incr&quot;)].info.repository.size.first()</params>
                                    <error_handler>DISCARD_VALUE</error_handler>
                                </step>
                                <step>
                                    <type>DISCARD_UNCHANGED_HEARTBEAT</type>
                                    <params>1d</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>pgbackrest.json</key>
                            </master_item>
                        </item_prototype>
                        <item_prototype>
                            <name>pgbackrest[{#NAME},incr,speed]</name>
                            <type>CALCULATED</type>
                            <key>pgbackrest[{#NAME},incr,speed]</key>
                            <delay>10m</delay>
                            <history>8d</history>
                            <value_type>FLOAT</value_type>
                            <units>Bps</units>
                            <params>last(&quot;pgbackrest[{#NAME},incr,repo,delta]&quot;) /&#13;
 (&#13;
last(&quot;pgbackrest[{#NAME},incr,stop]&quot;)-last(&quot;pgbackrest[{#NAME},incr,start]&quot;)&#13;
)</params>
                            <applications>
                                <application>
                                    <name>backup</name>
                                </application>
                            </applications>
                            <preprocessing>
                                <step>
                                    <type>DISCARD_UNCHANGED_HEARTBEAT</type>
                                    <params>1d</params>
                                </step>
                            </preprocessing>
                        </item_prototype>
                        <item_prototype>
                            <name>pgbackrest[{#NAME},incr,start]</name>
                            <type>DEPENDENT</type>
                            <key>pgbackrest[{#NAME},incr,start]</key>
                            <delay>0</delay>
                            <history>8d</history>
                            <units>unixtime</units>
                            <applications>
                                <application>
                                    <name>backup</name>
                                </application>
                            </applications>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$.[?(@.name==&quot;{#NAME}&quot; &amp;&amp; @.type==&quot;incr&quot;)].timestamp.start.first()</params>
                                    <error_handler>DISCARD_VALUE</error_handler>
                                </step>
                                <step>
                                    <type>DISCARD_UNCHANGED_HEARTBEAT</type>
                                    <params>1d</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>pgbackrest.json</key>
                            </master_item>
                        </item_prototype>
                        <item_prototype>
                            <name>pgbackrest[{#NAME},incr,stop]</name>
                            <type>DEPENDENT</type>
                            <key>pgbackrest[{#NAME},incr,stop]</key>
                            <delay>0</delay>
                            <history>8d</history>
                            <units>unixtime</units>
                            <applications>
                                <application>
                                    <name>backup</name>
                                </application>
                            </applications>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$.[?(@.name==&quot;{#NAME}&quot; &amp;&amp; @.type==&quot;incr&quot;)].timestamp.stop.first()</params>
                                    <error_handler>DISCARD_VALUE</error_handler>
                                </step>
                                <step>
                                    <type>DISCARD_UNCHANGED_HEARTBEAT</type>
                                    <params>1d</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>pgbackrest.json</key>
                            </master_item>
                        </item_prototype>
                        <item_prototype>
                            <name>pgbackrest[{#NAME},type]</name>
                            <type>DEPENDENT</type>
                            <key>pgbackrest[{#NAME},type]</key>
                            <delay>0</delay>
                            <history>8d</history>
                            <description>last backup type of {#NAME}</description>
                            <applications>
                                <application>
                                    <name>backup</name>
                                </application>
                            </applications>
                            <valuemap>
                                <name>pgbackrest_types</name>
                            </valuemap>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$.[?(@.name==&quot;{#NAME}&quot; )].type.first()</params>
                                </step>
                                <step>
                                    <type>STR_REPLACE</type>
                                    <params>full
0</params>
                                </step>
                                <step>
                                    <type>STR_REPLACE</type>
                                    <params>incr
1</params>
                                </step>
                                <step>
                                    <type>STR_REPLACE</type>
                                    <params>diff
2</params>
                                </step>
                                <step>
                                    <type>DISCARD_UNCHANGED_HEARTBEAT</type>
                                    <params>1d</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>pgbackrest.json</key>
                            </master_item>
                            <trigger_prototypes>
                                <trigger_prototype>
                                    <expression>{nodata(26h)}=1</expression>
                                    <name>no backup activity seen for {#NAME} in last 26h</name>
                                    <priority>AVERAGE</priority>
                                    <description>expecting a backup once a day, full or incremental</description>
                                    <tags>
                                        <tag>
                                            <tag>backup</tag>
                                            <value>{#NAME}-none</value>
                                        </tag>
                                    </tags>
                                </trigger_prototype>
                            </trigger_prototypes>
                        </item_prototype>
                        <item_prototype>
                            <name>pgbackrest[{#NAME},version]</name>
                            <type>DEPENDENT</type>
                            <key>pgbackrest[{#NAME},version]</key>
                            <delay>0</delay>
                            <history>8d</history>
                            <trends>0</trends>
                            <value_type>CHAR</value_type>
                            <applications>
                                <application>
                                    <name>backup</name>
                                </application>
                            </applications>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$.[?(@.name==&quot;{#NAME}&quot;)].backrest.version.first()</params>
                                </step>
                                <step>
                                    <type>DISCARD_UNCHANGED_HEARTBEAT</type>
                                    <params>1d</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>pgbackrest.json</key>
                            </master_item>
                        </item_prototype>
                    </item_prototypes>
                    <master_item>
                        <key>pgbackrest.json</key>
                    </master_item>
                    <lld_macro_paths>
                        <lld_macro_path>
                            <lld_macro>{#NAME}</lld_macro>
                            <path>$.name</path>
                        </lld_macro_path>
                        <lld_macro_path>
                            <lld_macro>{#TYPE}</lld_macro>
                            <path>$.type</path>
                        </lld_macro_path>
                    </lld_macro_paths>
                </discovery_rule>
            </discovery_rules>
            <tags>
                <tag>
                    <tag>app</tag>
                    <value>pgbackrest</value>
                </tag>
            </tags>
        </template>
    </templates>
    <value_maps>
        <value_map>
            <name>pgbackrest_types</name>
            <mappings>
                <mapping>
                    <value>0</value>
                    <newvalue>full</newvalue>
                </mapping>
                <mapping>
                    <value>1</value>
                    <newvalue>incr</newvalue>
                </mapping>
                <mapping>
                    <value>2</value>
                    <newvalue>diff</newvalue>
                </mapping>
            </mappings>
        </value_map>
    </value_maps>
</zabbix_export>
