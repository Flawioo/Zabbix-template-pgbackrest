<?xml version="1.0" encoding="UTF-8"?>
<zabbix_export>
    <version>5.0</version>
    <date>2022-01-18T16:35:30Z</date>
    <groups>
        <group>
            <name>rdbms/postgres</name>
        </group>
        <group>
            <name>Templates/SSCI</name>
        </group>
    </groups>
    <templates>
        <template>
            <template>postgres pgbackrest backup server</template>
            <name>postgres pgbackrest backup server</name>
            <description>monitoring of pgbackrest backups. Data is sent using zabbix_sender and preformatted using jq</description>
            <groups>
                <group>
                    <name>rdbms/postgres</name>
                </group>
                <group>
                    <name>Templates/SSCI</name>
                </group>
            </groups>
            <applications>
                <application>
                    <name>backup</name>
                </application>
            </applications>
            <items>
                <item>
                    <name>pgbackrest.json</name>
                    <type>TRAP</type>
                    <key>pgbackrest.json</key>
                    <delay>0</delay>
                    <history>0</history>
                    <trends>0</trends>
                    <value_type>TEXT</value_type>
                    <description>get latest backup info from pgbackrest info --output=json with some smart filtering in jq to only get the latest backup per database per type</description>
                    <applications>
                        <application>
                            <name>backup</name>
                        </application>
                    </applications>
                </item>
                <item>
                    <name>pgbackrest[count]</name>
                    <type>DEPENDENT</type>
                    <key>pgbackrest[count]</key>
                    <delay>0</delay>
                    <history>8d</history>
                    <description># of  backups by pgbackrest on this host (dbx, full + incr -&gt; 2)</description>
                    <applications>
                        <application>
                            <name>backup</name>
                        </application>
                    </applications>
                    <preprocessing>
                        <step>
                            <type>JSONPATH</type>
                            <params>$.length()</params>
                        </step>
                        <step>
                            <type>DISCARD_UNCHANGED_HEARTBEAT</type>
                            <params>1d</params>
                        </step>
                    </preprocessing>
                    <master_item>
                        <key>pgbackrest.json</key>
                    </master_item>
                </item>
            </items>
            <discovery_rules>
                <discovery_rule>
                    <name>pgbackrest.lld</name>
                    <type>DEPENDENT</type>
                    <key>pgbackrest.lld</key>
                    <delay>0</delay>
                    <item_prototypes>
                        <item_prototype>
                            <name>pgbackrest[{#NAME},{#TYPE},age]</name>
                            <type>DEPENDENT</type>
                            <key>pgbackrest[{#NAME},{#TYPE},age]</key>
                            <delay>0</delay>
                            <history>8d</history>
                            <units>s</units>
                            <description>age of last (#TYPE} backup in seconds</description>
                            <applications>
                                <application>
                                    <name>backup</name>
                                </application>
                            </applications>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$.[?(@.name==&quot;{#NAME}&quot; &amp;&amp; @.type==&quot;{#TYPE}&quot;)].timestamp.age.first()</params>
                                    <error_handler>DISCARD_VALUE</error_handler>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>pgbackrest.json</key>
                            </master_item>
                            <trigger_prototypes>
                                <trigger_prototype>
                                    <expression>{last()} &gt; {$MAX_BKUP_AGE:&quot;{#TYPE}&quot;}</expression>
                                    <name>last {#TYPE} backup of {#NAME} older than {$MAX_BKUP_AGE:&quot;{#TYPE}&quot;}</name>
                                    <priority>WARNING</priority>
                                    <description>expecting a regular pattern</description>
                                    <dependencies>
                                        <dependency>
                                            <name>no monitoring data for {#NAME}-{#TYPE}</name>
                                            <expression>{postgres pgbackrest backup server:pgbackrest[{#NAME},{#TYPE},age].nodata(4h)}=1</expression>
                                        </dependency>
                                    </dependencies>
                                    <tags>
                                        <tag>
                                            <tag>backup</tag>
                                            <value>{#NAME}-{#TYPE}</value>
                                        </tag>
                                    </tags>
                                </trigger_prototype>
                                <trigger_prototype>
                                    <expression>{nodata(4h)}=1</expression>
                                    <name>no monitoring data for {#NAME}-{#TYPE}</name>
                                    <priority>AVERAGE</priority>
                                    <description>age is always new and should always be received. Could be a monitoring script problem.</description>
                                    <tags>
                                        <tag>
                                            <tag>backup</tag>
                                            <value>{#NAME}-{#TYPE}</value>
                                        </tag>
                                        <tag>
                                            <tag>monitoring</tag>
                                        </tag>
                                    </tags>
                                </trigger_prototype>
                            </trigger_prototypes>
                        </item_prototype>
                        <item_prototype>
                            <name>pgbackrest[{#NAME},{#TYPE},arl,max]</name>
                            <type>DEPENDENT</type>
                            <key>pgbackrest[{#NAME},{#TYPE},arl,max]</key>
                            <delay>0</delay>
                            <history>15d</history>
                            <trends>0</trends>
                            <status>DISABLED</status>
                            <value_type>CHAR</value_type>
                            <description>Most recent archived log in repo available, only enabled for full (discovery override)</description>
                            <applications>
                                <application>
                                    <name>backup</name>
                                </application>
                            </applications>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$.[?(@.name==&quot;{#NAME}&quot; &amp;&amp; @.type==&quot;{#TYPE}&quot;)].max.first()</params>
                                </step>
                                <step>
                                    <type>DISCARD_UNCHANGED</type>
                                    <params/>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>pgbackrest.json</key>
                            </master_item>
                            <trigger_prototypes>
                                <trigger_prototype>
                                    <expression>{nodata({$ARCHIVER_LATE})}=1</expression>
                                    <name>no archives received for {#NAME} - {#TYPE}</name>
                                    <status>DISABLED</status>
                                    <priority>WARNING</priority>
                                    <description>archives are for all backuptypes so check only full,arl,max&#13;
the arl items are disabled and only enabled for full,arl,(min|max)</description>
                                    <dependencies>
                                        <dependency>
                                            <name>no monitoring data for {#NAME}-{#TYPE}</name>
                                            <expression>{postgres pgbackrest backup server:pgbackrest[{#NAME},{#TYPE},age].nodata(4h)}=1</expression>
                                        </dependency>
                                    </dependencies>
                                    <tags>
                                        <tag>
                                            <tag>archiving</tag>
                                        </tag>
                                        <tag>
                                            <tag>backup</tag>
                                            <value>{#NAME}-{#TYPE}</value>
                                        </tag>
                                    </tags>
                                </trigger_prototype>
                            </trigger_prototypes>
                        </item_prototype>
                        <item_prototype>
                            <name>pgbackrest[{#NAME},{#TYPE},arl,min]</name>
                            <type>DEPENDENT</type>
                            <key>pgbackrest[{#NAME},{#TYPE},arl,min]</key>
                            <delay>0</delay>
                            <history>15d</history>
                            <trends>0</trends>
                            <status>DISABLED</status>
                            <value_type>CHAR</value_type>
                            <description>Oldest archived log in repo available, only enabled for full (discovery override)</description>
                            <applications>
                                <application>
                                    <name>backup</name>
                                </application>
                            </applications>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$.[?(@.name==&quot;{#NAME}&quot; &amp;&amp; @.type==&quot;{#TYPE}&quot;)].min.first()</params>
                                </step>
                                <step>
                                    <type>DISCARD_UNCHANGED</type>
                                    <params/>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>pgbackrest.json</key>
                            </master_item>
                        </item_prototype>
                        <item_prototype>
                            <name>pgbackrest[{#NAME},{#TYPE},db,delta]</name>
                            <type>DEPENDENT</type>
                            <key>pgbackrest[{#NAME},{#TYPE},db,delta]</key>
                            <delay>0</delay>
                            <history>8d</history>
                            <units>B</units>
                            <applications>
                                <application>
                                    <name>backup</name>
                                </application>
                            </applications>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$.[?(@.name==&quot;{#NAME}&quot; &amp;&amp; @.type==&quot;{#TYPE}&quot;)].info.delta.first()</params>
                                    <error_handler>DISCARD_VALUE</error_handler>
                                </step>
                                <step>
                                    <type>DISCARD_UNCHANGED_HEARTBEAT</type>
                                    <params>1d</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>pgbackrest.json</key>
                            </master_item>
                        </item_prototype>
                        <item_prototype>
                            <name>pgbackrest[{#NAME},{#TYPE},db,size]</name>
                            <type>DEPENDENT</type>
                            <key>pgbackrest[{#NAME},{#TYPE},db,size]</key>
                            <delay>0</delay>
                            <history>8d</history>
                            <units>B</units>
                            <description>dbsize as it runs</description>
                            <applications>
                                <application>
                                    <name>backup</name>
                                </application>
                            </applications>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$.[?(@.name==&quot;{#NAME}&quot; &amp;&amp; @.type==&quot;{#TYPE}&quot;)].info.size.first()</params>
                                    <error_handler>DISCARD_VALUE</error_handler>
                                </step>
                                <step>
                                    <type>DISCARD_UNCHANGED_HEARTBEAT</type>
                                    <params>1d</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>pgbackrest.json</key>
                            </master_item>
                        </item_prototype>
                        <item_prototype>
                            <name>pgbackrest[{#NAME},{#TYPE},repo,delta]</name>
                            <type>DEPENDENT</type>
                            <key>pgbackrest[{#NAME},{#TYPE},repo,delta]</key>
                            <delay>0</delay>
                            <history>8d</history>
                            <units>B</units>
                            <applications>
                                <application>
                                    <name>backup</name>
                                </application>
                            </applications>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$.[?(@.name==&quot;{#NAME}&quot; &amp;&amp; @.type==&quot;{#TYPE}&quot;)].info.repository.delta.first()</params>
                                    <error_handler>DISCARD_VALUE</error_handler>
                                </step>
                                <step>
                                    <type>DISCARD_UNCHANGED_HEARTBEAT</type>
                                    <params>1d</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>pgbackrest.json</key>
                            </master_item>
                        </item_prototype>
                        <item_prototype>
                            <name>pgbackrest[{#NAME},{#TYPE},repo,size]</name>
                            <type>DEPENDENT</type>
                            <key>pgbackrest[{#NAME},{#TYPE},repo,size]</key>
                            <delay>0</delay>
                            <history>8d</history>
                            <units>B</units>
                            <description>size of db in the repository</description>
                            <applications>
                                <application>
                                    <name>backup</name>
                                </application>
                            </applications>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$.[?(@.name==&quot;{#NAME}&quot; &amp;&amp; @.type==&quot;{#TYPE}&quot;)].info.repository.size.first()</params>
                                    <error_handler>DISCARD_VALUE</error_handler>
                                </step>
                                <step>
                                    <type>DISCARD_UNCHANGED_HEARTBEAT</type>
                                    <params>1d</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>pgbackrest.json</key>
                            </master_item>
                        </item_prototype>
                        <item_prototype>
                            <name>pgbackrest[{#NAME},{#TYPE},start]</name>
                            <type>DEPENDENT</type>
                            <key>pgbackrest[{#NAME},{#TYPE},start]</key>
                            <delay>0</delay>
                            <history>8d</history>
                            <units>unixtime</units>
                            <description>The time this backup started</description>
                            <applications>
                                <application>
                                    <name>backup</name>
                                </application>
                            </applications>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$.[?(@.name==&quot;{#NAME}&quot; &amp;&amp; @.type==&quot;{#TYPE}&quot;)].timestamp.start.first()</params>
                                    <error_handler>DISCARD_VALUE</error_handler>
                                </step>
                                <step>
                                    <type>DISCARD_UNCHANGED_HEARTBEAT</type>
                                    <params>1d</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>pgbackrest.json</key>
                            </master_item>
                        </item_prototype>
                        <item_prototype>
                            <name>pgbackrest[{#NAME},{#TYPE},stop]</name>
                            <type>DEPENDENT</type>
                            <key>pgbackrest[{#NAME},{#TYPE},stop]</key>
                            <delay>0</delay>
                            <history>8d</history>
                            <units>unixtime</units>
                            <description>The time this backup ended</description>
                            <applications>
                                <application>
                                    <name>backup</name>
                                </application>
                            </applications>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$.[?(@.name==&quot;{#NAME}&quot; &amp;&amp; @.type==&quot;{#TYPE}&quot;)].timestamp.stop.first()</params>
                                    <error_handler>DISCARD_VALUE</error_handler>
                                </step>
                                <step>
                                    <type>DISCARD_UNCHANGED_HEARTBEAT</type>
                                    <params>1d</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>pgbackrest.json</key>
                            </master_item>
                        </item_prototype>
                        <item_prototype>
                            <name>pgbackrest[{#NAME},{#TYPE},version]</name>
                            <type>DEPENDENT</type>
                            <key>pgbackrest[{#NAME},{#TYPE},version]</key>
                            <delay>0</delay>
                            <history>8d</history>
                            <trends>0</trends>
                            <value_type>CHAR</value_type>
                            <description>version of pgbackrest used for this backup</description>
                            <applications>
                                <application>
                                    <name>backup</name>
                                </application>
                            </applications>
                            <preprocessing>
                                <step>
                                    <type>JSONPATH</type>
                                    <params>$.[?(@.name==&quot;{#NAME}&quot; &amp;&amp; @.type==&quot;{#TYPE}&quot;)].backrest.version.first()</params>
                                </step>
                                <step>
                                    <type>DISCARD_UNCHANGED_HEARTBEAT</type>
                                    <params>1d</params>
                                </step>
                            </preprocessing>
                            <master_item>
                                <key>pgbackrest.json</key>
                            </master_item>
                        </item_prototype>
                        <item_prototype>
                            <name>pgbackrest[{#NAME},{#TYPE},wspeed]</name>
                            <type>CALCULATED</type>
                            <key>pgbackrest[{#NAME},{#TYPE},wspeed]</key>
                            <delay>10m</delay>
                            <history>8d</history>
                            <value_type>FLOAT</value_type>
                            <units>Bps</units>
                            <params>last(&quot;pgbackrest[{#NAME},{#TYPE},repo,delta]&quot;,0) /&#13;
 (last(&quot;pgbackrest[{#NAME},{#TYPE},stop]&quot;,0)-last(&quot;pgbackrest[{#NAME},{#TYPE},start]&quot;,0))</params>
                            <description>write speed for the backup piece</description>
                            <applications>
                                <application>
                                    <name>backup</name>
                                </application>
                            </applications>
                            <preprocessing>
                                <step>
                                    <type>DISCARD_UNCHANGED_HEARTBEAT</type>
                                    <params>1d</params>
                                </step>
                            </preprocessing>
                        </item_prototype>
                    </item_prototypes>
                    <master_item>
                        <key>pgbackrest.json</key>
                    </master_item>
                    <lld_macro_paths>
                        <lld_macro_path>
                            <lld_macro>{#NAME}</lld_macro>
                            <path>$.name</path>
                        </lld_macro_path>
                        <lld_macro_path>
                            <lld_macro>{#TYPE}</lld_macro>
                            <path>$.type</path>
                        </lld_macro_path>
                    </lld_macro_paths>
                    <overrides>
                        <override>
                            <name>arl tracking only for full</name>
                            <step>1</step>
                            <filter>
                                <conditions>
                                    <condition>
                                        <macro>{#TYPE}</macro>
                                        <value>full</value>
                                        <formulaid>A</formulaid>
                                    </condition>
                                </conditions>
                            </filter>
                            <operations>
                                <operation>
                                    <operationobject>ITEM_PROTOTYPE</operationobject>
                                    <value>full,arl,.*]$</value>
                                    <status>ENABLED</status>
                                </operation>
                                <operation>
                                    <operationobject>TRIGGER_PROTOTYPE</operationobject>
                                    <value>,arl,</value>
                                    <status>ENABLED</status>
                                </operation>
                            </operations>
                        </override>
                    </overrides>
                </discovery_rule>
            </discovery_rules>
            <tags>
                <tag>
                    <tag>app</tag>
                    <value>pgbackrest</value>
                </tag>
            </tags>
            <macros>
                <macro>
                    <macro>{$ARCHIVER_LATE}</macro>
                    <value>1d</value>
                    <description>warn if archives are not received after this</description>
                </macro>
                <macro>
                    <macro>{$MAX_BKUP_AGE}</macro>
                    <value>8d</value>
                    <description>7d but prefer not to trigger during a large backup</description>
                </macro>
                <macro>
                    <macro>{$MAX_BKUP_AGE:incr}</macro>
                    <value>2d</value>
                    <description>1d but prefer not to trigger during a large backup</description>
                </macro>
                <macro>
                    <macro>{$PGBACKREST_REPO1_PATH}</macro>
                    <value>/var/lib/bart/pgbackrest/repo1</value>
                    <description>from /etc/pgbackup/pgbackup.conf repo1-path</description>
                </macro>
            </macros>
        </template>
    </templates>
</zabbix_export>
